{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Pago por Transferencia | AutoParts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/favicon.ico.png' %}" type="image/x-icon">
    
    <!-- Fuentes e íconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    
    <!-- Estilos -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    {% include "base/header.html" %}
</head>
<body>
<main class="container contenido-con-navbar" style="padding-top: 180px;" 
      data-order-id="{{ order_id }}" 
      data-total="{{ total|floatformat:0 }}">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h3><i class="fas fa-university"></i> Pago por Transferencia Bancaria</h3>
                </div>
                <div class="card-body">
                    <!-- Información del pedido -->
                    <div class="alert alert-success mb-4">
                        <h5><i class="fas fa-check-circle"></i> ¡Pedido creado exitosamente!</h5>
                        <p class="mb-1"><strong>Número de pedido:</strong> {{ order_id }}</p>
                        <p class="mb-1"><strong>Total a pagar:</strong> $<span class="precio-chileno">{{ total|floatformat:0 }}</span></p>
                        <p class="mb-0"><strong>Estado:</strong> <span class="badge bg-warning">Pendiente de pago</span></p>
                    </div>

                    <!-- Datos bancarios -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6><i class="fas fa-bank"></i> Datos Bancarios</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Banco:</strong> Banco Santander</p>
                                    <p><strong>Tipo de Cuenta:</strong> Cuenta Corriente</p>
                                    <p><strong>Número de Cuenta:</strong> 0 000 85 73422 9</p>
                                    <p><strong>RUT Titular:</strong> 20.654.445-7 </p>
                                    <p class="mb-0"><strong>Titular:</strong> AutoParts SpA</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning mb-3">
                                <div class="card-header bg-warning text-dark">
                                    <h6><i class="fas fa-exclamation-triangle"></i> Datos de Contacto</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Email:</strong> pagos@autoparts.cl</p>
                                    <p><strong>Teléfono:</strong> +56 9 8765 4321</p>
                                    <p><strong>WhatsApp:</strong> +56 9 8765 4321</p>
                                    <p class="mb-0"><strong>Horario:</strong> Lun-Vie 9:00-18:00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instrucciones -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Instrucciones de Pago</h6>
                        <ol class="mb-0">
                            <li><strong>Realiza la transferencia</strong> por el monto exacto: <strong>$<span class="precio-chileno">{{ total|floatformat:0 }}</span></strong></li>
                            <li><strong>En el comentario/glosa</strong> incluye tu número de pedido: <strong>{{ order_id }}</strong></li>
                            <li><strong>Envía el comprobante</strong> por email a: <a href="mailto:pagos@autoparts.cl">pagos@autoparts.cl</a></li>
                            <li><strong>Incluye en el email:</strong>
                                <ul>
                                    <li>Número de pedido: {{ order_id }}</li>
                                    <li>Tu nombre completo</li>
                                    <li>Foto o captura del comprobante de transferencia</li>
                                </ul>
                            </li>
                            <li><strong>Confirmaremos tu pago</strong> en un máximo de 24 horas hábiles</li>
                        </ol>
                    </div>

                    <!-- Resumen del pedido -->
                    <div class="card border-secondary mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-shopping-cart"></i> Resumen del Pedido</h6>
                        </div>
                        <div class="card-body">
                            {% if productos %}
                                {% for producto in productos %}
                                <div class="row border-bottom py-2">
                                    <div class="col-8">
                                        <strong>{{ producto.producto }}</strong><br>
                                        <small class="text-muted">Cantidad: {{ producto.cantidad }}</small>
                                    </div>
                                    <div class="col-4 text-end">
                                        <strong>$<span class="precio-chileno">{{ producto.subtotal|floatformat:0 }}</span></strong>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            <div class="row border-top pt-2 mt-2">
                                <div class="col-8"><strong>Subtotal:</strong></div>
                                <div class="col-4 text-end">$<span class="precio-chileno">{{ subtotal|floatformat:0 }}</span></div>
                            </div>
                            <div class="row">
                                <div class="col-8"><strong>IVA (19%):</strong></div>
                                <div class="col-4 text-end">$<span class="precio-chileno">{{ iva|floatformat:0 }}</span></div>
                            </div>
                            {% if costo_envio and costo_envio > 0 %}
                            <div class="row">
                                <div class="col-8"><strong>Costo de envío:</strong></div>
                                <div class="col-4 text-end">$<span class="precio-chileno">{{ costo_envio|floatformat:0 }}</span></div>
                            </div>
                            {% endif %}
                            <div class="row border-top pt-2 mt-2">
                                <div class="col-8"><h5><strong>Total:</strong></h5></div>
                                <div class="col-4 text-end"><h5><strong>$<span class="precio-chileno">{{ total|floatformat:0 }}</span></strong></h5></div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <a href="#" id="btn-email" class="btn btn-success w-100">
                                <i class="fas fa-envelope"></i> Enviar Comprobante por Email
                            </a>
                        </div>
                        <div class="col-md-6 mb-2">
                            <a href="#" id="btn-whatsapp" target="_blank" class="btn btn-success w-100">
                                <i class="fab fa-whatsapp"></i> Contactar por WhatsApp
                            </a>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6 mb-2">
                            <a href="{% url 'perfil' %}" class="btn btn-primary w-100">
                                <i class="fas fa-user"></i> Ver Mis Pedidos
                            </a>
                        </div>
                        <div class="col-md-6 mb-2">
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-home"></i> Volver al Inicio
                            </a>
                        </div>
                    </div>

                    <!-- Nota importante -->
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-clock"></i> Importante</h6>
                        <p class="mb-1">• Tu pedido se mantendrá reservado por <strong>48 horas</strong> mientras confirmamos el pago.</p>
                        <p class="mb-1">• Una vez confirmado el pago, procederemos con el despacho según el método de entrega seleccionado.</p>
                        <p class="mb-0">• Si tienes dudas, contáctanos a <strong>pagos@autoparts.cl</strong> o al <strong>+56 9 8765 4321</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

{% include "base/footer.html" %}

<script src="{% static 'js/auth.js' %}"></script>
<script>
// Función para formatear precios con separadores de miles (formato chileno)
function formatPriceChilean(price) {
    return Math.round(price).toLocaleString('es-CL');
}

// Auto-copiar datos bancarios al hacer clic
function copiarTexto(texto) {
    navigator.clipboard.writeText(texto).then(() => {
        alert('Datos copiados al portapapeles');
    });
}

// Agregar funcionalidad de copia y formateo de precios
document.addEventListener('DOMContentLoaded', () => {
    // Obtener datos del pedido desde atributos de datos
    const mainElement = document.querySelector('main');
    const orderId = mainElement.dataset.orderId;
    const totalOriginal = parseFloat(mainElement.dataset.total);
    const totalFormateado = formatPriceChilean(totalOriginal);
    
    // Formatear todos los precios al estilo chileno
    const elementosPrecios = document.querySelectorAll('.precio-chileno');
    elementosPrecios.forEach(elem => {
        const precio = parseFloat(elem.textContent.replace(/[^\d]/g, ''));
        if (!isNaN(precio)) {
            elem.textContent = formatPriceChilean(precio);
        }
    });
    
    // Configurar enlaces de email y WhatsApp
    const btnEmail = document.getElementById('btn-email');
    const btnWhatsapp = document.getElementById('btn-whatsapp');
    
    if (btnEmail) {
        const emailSubject = `Comprobante de Pago - Pedido ${orderId}`;
        const emailBody = `Estimados,%0A%0AAdjunto el comprobante de transferencia para el pedido ${orderId} por un total de $${totalFormateado}.%0A%0AMi nombre completo: [ESCRIBIR AQUÍ]%0A%0ASaludos cordiales.`;
        btnEmail.href = `mailto:pagos@autoparts.cl?subject=${emailSubject}&body=${emailBody}`;
    }
    
    if (btnWhatsapp) {
        const whatsappText = `Hola, realicé una transferencia para el pedido ${orderId} por $${totalFormateado}. ¿Podrían confirmar el pago?`;
        btnWhatsapp.href = `https://wa.me/56987654321?text=${encodeURIComponent(whatsappText)}`;
    }
    
    // Agregar botones de copia a los datos bancarios
    const datosBancarios = document.querySelectorAll('.card-body p');
    datosBancarios.forEach(p => {
        if (p.innerHTML.includes('Banco:') || 
            p.innerHTML.includes('Número de Cuenta:') || 
            p.innerHTML.includes('RUT Titular:')) {
            p.style.cursor = 'pointer';
            p.title = 'Haz clic para copiar';
            p.addEventListener('click', () => {
                const texto = p.textContent.split(':')[1].trim();
                copiarTexto(texto);
            });
        }
    });
});
</script>

</body>
</html>
