{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Pago Rechazado - AutoParts</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="icon" href="{% static 'img/favicon.ico.png' %}" type="image/x-icon"> 

    <!-- Fuentes y estilos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Librer√≠as -->
    <link href="{% static 'lib/lightbox/css/lightbox.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">

    <!-- Bootstrap y estilos -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <style>
        .pago-rechazado-container {
            padding-top: 180px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .rechazo-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .rechazo-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .rechazo-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .rechazo-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .rechazo-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .info-section {
            background: white;
            padding: 30px;
        }
        
        .pedido-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .motivo-rechazo {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .opciones-container {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .opcion-pago {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .opcion-pago:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
        }
        
        .opcion-pago.selected {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .btn-reintentar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .btn-reintentar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .btn-volver {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .btn-volver:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .timeline-item.current::before {
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .contacto-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>

    {% include "base/header.html" %}
</head>
<body>
<div class="pago-rechazado-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                <div class="rechazo-card">
                    <!-- Header con estado de rechazo -->
                    <div class="rechazo-header">
                        <div class="rechazo-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h1 class="rechazo-title">Pago Rechazado</h1>
                        <p class="rechazo-subtitle">Tu transacci√≥n no pudo ser procesada</p>
                    </div>
                    
                    <!-- Informaci√≥n del pedido -->
                    <div class="info-section">
                        <div class="pedido-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-shopping-bag"></i> Informaci√≥n del Pedido
                                    </h6>
                                    <p><strong>N√∫mero de Pedido:</strong><br>
                                    <span class="text-primary" id="order-id">#{{ order_id|default:"No disponible" }}</span></p>
                                    <p><strong>Monto Total:</strong><br>
                                    <span class="h5 text-success" id="monto-total">${{ monto|default:"0"|floatformat:0 }}</span></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-clock"></i> Estado Actual
                                    </h6>
                                    <div class="timeline">
                                        <div class="timeline-item">
                                            <strong>Pedido Creado</strong><br>
                                            <small class="text-muted">{{ fecha|default:"Ahora" }}</small>
                                        </div>
                                        <div class="timeline-item">
                                            <strong>Pago Iniciado</strong><br>
                                            <small class="text-muted">WebPay Plus</small>
                                        </div>
                                        <div class="timeline-item current">
                                            <strong>Pago Rechazado</strong><br>
                                            <small class="text-danger">Transacci√≥n fallida</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Motivo del rechazo -->
                        <div class="motivo-rechazo">
                            <h6 class="text-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i> ¬øPor qu√© fue rechazado mi pago?
                            </h6>
                            <p class="mb-2"><strong>Posibles motivos:</strong></p>
                            <ul class="mb-0">
                                <li>Fondos insuficientes en la cuenta</li>
                                <li>Tarjeta vencida o bloqueada</li>
                                <li>Datos incorrectos ingresados</li>
                                <li>L√≠mite de compra excedido</li>
                                <li>Problema temporal con el banco</li>
                            </ul>
                        </div>
                        
                        <!-- Opciones para continuar -->
                        <div class="opciones-container">
                            <h6 class="text-primary mb-4">
                                <i class="fas fa-lightbulb"></i> ¬øQu√© puedes hacer ahora?
                            </h6>
                            
                            
                            <!-- Botones de acci√≥n -->
                            <div class="text-center mt-4">
                                <button class="btn btn-secondary btn-volver" onclick="volverAlCarrito()">
                                    <i class="fas fa-shopping-cart"></i> Volver al Carrito
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de contacto -->
                        <div class="contacto-info">
                            <h6 class="mb-3">
                                <i class="fas fa-headset"></i> ¬øNecesitas Ayuda?
                            </h6>
                            <p class="mb-2">Nuestro equipo est√° aqu√≠ para ayudarte</p>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <i class="fas fa-phone"></i><br>
                                    <small>+56 9 1234 5678</small>
                                </div>
                                <div class="col-md-4">
                                    <i class="fas fa-envelope"></i><br>
                                    <small>soporte@autoparts.cl</small>
                                </div>
                                <div class="col-md-4">
                                    <i class="fas fa-clock"></i><br>
                                    <small>Lun-Vie 9:00-18:00</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="text-center">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Procesando...</span>
        </div>
        <p class="text-light mt-3">Procesando tu solicitud...</p>
    </div>
</div>

{% include "base/footer.html" %}

<!-- Scripts JS principales -->
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script src="{% static 'lib/easing/easing.min.js' %}"></script>
<script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
<script src="{% static 'lib/lightbox/js/lightbox.min.js' %}"></script>
<script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>

<!-- Scripts espec√≠ficos -->
<script src="{% static 'js/auth_manager.js' %}"></script>

<script>
let opcionSeleccionada = 'reintentar'; // Por defecto reintentar
let orderData = {
    order_id: '{{ order_id|default:"" }}',
    monto: parseFloat('{{ monto|default:0 }}') || 0,
    email: '{{ email|default:"" }}',
    user_id: parseInt('{{ user_id|default:0 }}') || 0
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('üî¥ P√°gina de pago rechazado cargada');
    console.log('üì¶ Datos del pedido:', orderData);
    
    // Configurar eventos para las opciones
    setupOpcionesEventos();
    
    // Seleccionar opci√≥n por defecto
    document.querySelector('[data-opcion="reintentar"]').classList.add('selected');
});

function setupOpcionesEventos() {
    document.querySelectorAll('.opcion-pago').forEach(opcion => {
        opcion.addEventListener('click', function() {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.opcion-pago').forEach(o => o.classList.remove('selected'));
            
            // Seleccionar nueva opci√≥n
            this.classList.add('selected');
            opcionSeleccionada = this.getAttribute('data-opcion');
            
            console.log('‚úÖ Opci√≥n seleccionada:', opcionSeleccionada);
        });
    });
}

async function procesarOpcion() {
    if (!orderData.order_id) {
        alert('Error: No se encontr√≥ informaci√≥n del pedido');
        return;
    }
    
    showLoading(true);
    
    try {
        if (opcionSeleccionada === 'reintentar') {
            await reintentarPagoWebPay();
        } else if (opcionSeleccionada === 'transferencia') {
            await cambiarATransferencia();
        }
    } catch (error) {
        console.error('‚ùå Error procesando opci√≥n:', error);
        alert('Hubo un error procesando tu solicitud. Intenta nuevamente.');
        showLoading(false);
    }
}

async function reintentarPagoWebPay() {
    console.log('üîÑ Reintentando pago con WebPay...');
    
    try {
        // Recrear el pedido y redirigir a WebPay
        const response = await fetch('/api/reintentar-pago-webpay/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': `Token ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify({
                order_id: orderData.order_id
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.url) {
            console.log('‚úÖ Reintento iniciado, redirigiendo a WebPay...');
            window.location.href = data.url;
        } else {
            throw new Error(data.message || 'Error al reintentar el pago');
        }
        
    } catch (error) {
        console.error('‚ùå Error en reintento:', error);
        throw error;
    }
}

async function cambiarATransferencia() {
    console.log('üè¶ Cambiando a pago por transferencia...');
    
    try {
        const response = await fetch('/api/cambiar-a-transferencia/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': `Token ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify({
                order_id: orderData.order_id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Cambio a transferencia exitoso');
            window.location.href = `/pago-transferencia/${orderData.order_id}/`;
        } else {
            throw new Error(data.message || 'Error al cambiar a transferencia');
        }
        
    } catch (error) {
        console.error('‚ùå Error cambiando a transferencia:', error);
        throw error;
    }
}

function volverAlCarrito() {
    console.log('üõí Volviendo al carrito...');
    window.location.href = '/carrito/';
}

function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>
